Id saId = 'a1DS900000CBY4gMAH'; //SA already created manually
Id mainCaseId = '500S900000SkGbAIAV'; //main complaint case already created manually
 
System.debug('ðŸš€ Starting Creation (Full Hierarchy with Fixed Relationships)...');
 
// --- 1. DUMMY PARENTS (Required for Gas Card) ---
Account parentAccount = new Account(Name = 'Test Hierarchy Account');
insert parentAccount;
 
Contact customerContact = new Contact(
    AccountId = parentAccount.Id,
    LastName = 'Test Customer Contact',
    Email = 'test@example.com'
);
insert customerContact;
 
// --- 2. SERVICE ACCOUNT CHILDREN ---
insert new Addon__c(Service_Account__c = saId);
insert new Communication__c(Service_Account__c = saId);
insert new Contact_Permission__c(Service_Account__c = saId, Account_Binding_Key__c = 'TEST-KEY-' + System.currentTimeMillis());
 
insert new Gas_Card__c(
    Service_Account__c = saId,
    Customer__c = customerContact.Id,        
    Address_Line_1__c = '123 Test Street',   
    Town_City__c = 'Test City',              
    Postcode__c = 'TE1 5ST'                  
);
 
insert new SSE_Migration_Flags__c(Service_Account__c = saId, SSE_Service_Account_Id__c = saId);
insert new SSE_Migration_Reference__c(Service_Account__c = saId, SSE_Service_Account_Id__c = saId);
 
// --- 3. AGENTS (SA Level - Fixed Emails) ---
Agent__c saAgent = new Agent__c(Service_Account__c = saId);
insert saAgent;
 
// Email 1: Linked to Agent
insert new EmailMessage(
    RelatedToId = saAgent.Id, 
    Subject = 'Agent Direct Email', 
    FromAddress = 'test@example.com', 
    ToAddress = 'user@example.com'
);
 
Agent_Action__c agentAction = new Agent_Action__c(Agent__c = saAgent.Id);
insert agentAction;
 
// Email 2: Linked to Agent Action
insert new EmailMessage(
    RelatedToId = agentAction.Id, 
    Subject = 'Agent Action Email', 
    FromAddress = 'test@example.com', 
    ToAddress = 'user@example.com'
);
 
// --- 4. DIRECT DEBITS ---
Direct_Debit_Mandate__c ddm = new Direct_Debit_Mandate__c(
    Service_Account__c = saId,
    Mandate_ID__c = 'DDM-' + System.currentTimeMillis()
);
insert ddm;
 
insert new Direct_Debit_Subscription__c(
    Service_Account__c = saId, 
    Direct_Debit_Mandate__c = ddm.Id,
    Subscription_ID__c = 'SUB-' + System.currentTimeMillis()
);
 
// --- 5. SUPPLY POINTS ---
Supply_Point__c sp = new Supply_Point__c(Name = 'Linked Supply Point');
insert sp;
insert new Supply_Point_Ownership__c(Service_Account__c = saId, Supply_Point__c = sp.Id);
 
insert new Dispute__c(
    Supply_Point__c = sp.Id,
    Dispute_Id__c = 'DIS-' + System.currentTimeMillis()
);
 
insert new Gas_Card__c(
    Service_Account__c = saId, 
    Meter_Point_Reference__c = sp.Id, 
    Customer__c = customerContact.Id,
    Address_Line_1__c = '456 Supply Road', 
    Town_City__c = 'Supply City', 
    Postcode__c = 'SP1 9RD'
);
 
 
// --- 6. MAIN CASE RELATED RECORDS (Fixed Internal Case) ---
insert new Agent__c(Case__c = mainCaseId);
 
// Fetch 'Type' dynamically
String validType = 'Inbound Call';
Schema.DescribeFieldResult fieldResult = Case_Action__c.Type__c.getDescribe();
List<Schema.PicklistEntry> picklistValues = fieldResult.getPicklistValues();
if(!picklistValues.isEmpty()) validType = picklistValues[0].getValue();
 
// Case Action 1: Linked via Case__c
insert new Case_Action__c(
    Case__c = mainCaseId, 
    Action__c = 'Callback', 
    Type__c = validType
);
 
// Case Action 2: Linked via Internal_Case__c
insert new Case_Action__c(
    Internal_Case__c = mainCaseId, // <--- Correctly testing the secondary relationship
    Action__c = 'Callback', 
    Type__c = validType
);
 
insert new EmailMessage(ParentId = mainCaseId, Subject = 'Case Email', FromAddress = 'test@example.com', ToAddress = 'user@example.com');
insert new Knowledge_Article_Tracking__c(Case__c = mainCaseId);
 
System.debug('âœ… SUCCESS! All records created with correct emails and relationships.');

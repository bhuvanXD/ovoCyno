// === üöÄ FINAL ROBUST CREATION SCRIPT (FIXED) ===
Id saId = 'a1DS900000CBY4gMAH';       // REPLACE with your Service Account ID
Id mainCaseId = '500S900000SkGbAIAV'; // REPLACE with your Main Case ID

System.debug('üöÄ STARTING DATA CREATION...');

try {
    // --- 1. DUMMY PARENTS ---
    Account parentAccount = new Account(Name = 'Test Hierarchy Account');
    insert parentAccount;

    Contact customerContact = new Contact(
        AccountId = parentAccount.Id,
        LastName = 'Test Customer Contact',
        Email = 'test@example.com'
    );
    insert customerContact;

    // --- 2. SERVICE ACCOUNT CHILDREN ---
    List<SObject> saChildren = new List<SObject>{
        new Addon__c(Service_Account__c = saId),
        new Communication__c(Service_Account__c = saId),
        new Contact_Permission__c(Service_Account__c = saId, Account_Binding_Key__c = 'KEY-' + System.currentTimeMillis()),
        new SSE_Migration_Flags__c(Service_Account__c = saId, SSE_Service_Account_Id__c = saId),
        new SSE_Migration_Reference__c(Service_Account__c = saId, SSE_Service_Account_Id__c = saId),
        
        // ‚úÖ FIXED: Added Town_City__c here
        new Gas_Card__c(
            Service_Account__c = saId, 
            Customer__c = customerContact.Id, 
            Address_Line_1__c = '123 Test St', 
            Town_City__c = 'Test City',  // <-- Added Required Field
            Postcode__c = 'TE1 5ST'
        )
    };
    insert saChildren;
    System.debug('‚úÖ Service Account Children Created.');

    // --- 3. AGENTS (SA Level) ---
    Agent__c saAgent = new Agent__c(Service_Account__c = saId);
    insert saAgent;
    insert new EmailMessage(RelatedToId = saAgent.Id, Subject = 'Agent Email', FromAddress = 'test@test.com', ToAddress = 'test@test.com');

    Agent_Action__c agentAction = new Agent_Action__c(Agent__c = saAgent.Id);
    insert agentAction;
    insert new EmailMessage(RelatedToId = agentAction.Id, Subject = 'Action Email', FromAddress = 'test@test.com', ToAddress = 'test@test.com');
    System.debug('‚úÖ Agent Hierarchy Created.');

    // --- 4. FINANCIALS ---
    Direct_Debit_Mandate__c ddm = new Direct_Debit_Mandate__c(Service_Account__c = saId, Mandate_ID__c = 'DD-' + System.currentTimeMillis());
    insert ddm;
    insert new Direct_Debit_Subscription__c(Service_Account__c = saId, Direct_Debit_Mandate__c = ddm.Id, Subscription_ID__c = 'SUB-' + System.currentTimeMillis());

    // --- 5. SUPPLY POINTS ---
    Supply_Point__c sp = new Supply_Point__c(Name = 'Linked SP');
    insert sp;
    insert new Supply_Point_Ownership__c(Service_Account__c = saId, Supply_Point__c = sp.Id);
    insert new Dispute__c(Supply_Point__c = sp.Id, Dispute_Id__c = 'DIS-' + System.currentTimeMillis());
    
    // Gas Card on Supply Point (This one was already correct)
    insert new Gas_Card__c(Service_Account__c = saId, Meter_Point_Reference__c = sp.Id, Customer__c = customerContact.Id, Address_Line_1__c = 'SP Card', Town_City__c = 'Supply City', Postcode__c = 'SP1 1AA');
    System.debug('‚úÖ Financials & Supply Created.');

    // --- 6. MAIN CASE HIERARCHY ---
    insert new Agent__c(Case__c = mainCaseId);
    
    // Get Valid Picklist
    String validType = 'Inbound Call';
    List<Schema.PicklistEntry> pEntries = Case_Action__c.Type__c.getDescribe().getPicklistValues();
    if(!pEntries.isEmpty()) validType = pEntries[0].getValue();

    insert new Case_Action__c(Case__c = mainCaseId, Action__c = 'Callback', Type__c = validType);
    
    // Independent Insert for Internal Action
    try {
        insert new Case_Action__c(Internal_Case__c = mainCaseId, Action__c = 'Callback', Type__c = validType);
        System.debug('‚úÖ Internal Case Action Created.');
    } catch(Exception e) { System.debug('‚ö†Ô∏è Internal Action Failed: ' + e.getMessage()); }

    // Independent Insert for Case Email
    try {
        insert new EmailMessage(ParentId = mainCaseId, Subject = 'Case Email', FromAddress = 'test@test.com', ToAddress = 'test@test.com');
        System.debug('‚úÖ Case Email Created.');
    } catch(Exception e) { System.debug('‚ö†Ô∏è Case Email Failed: ' + e.getMessage()); }

    // Independent Insert for Knowledge
    try {
        insert new Knowledge_Article_Tracking__c(Case__c = mainCaseId);
        System.debug('‚úÖ Knowledge Tracking Created.');
    } catch(Exception e) { System.debug('‚ö†Ô∏è Knowledge Failed: ' + e.getMessage()); }

    // --- 7. OMBUDSMAN HIERARCHY ---
    Integer randomNum = Math.round(Math.random() * 899999) + 100000;
    String uniqueRef = 'AB' + String.valueOf(randomNum) + '-23';

    try {
        Ombudsman_Case__c ombCase = new Ombudsman_Case__c(Case__c = mainCaseId, Name = uniqueRef);
        insert ombCase;
        
        insert new Ombudsman_Resolution__c(
            Ombudsman_Case__c = ombCase.Id,
            Resolution_Case__c = mainCaseId,
            Ombudsman_Remedy__c = 'abc'
        );
        System.debug('‚úÖ Ombudsman Hierarchy Created (Ref: ' + uniqueRef + ')');
    } catch(Exception e) { System.debug('‚ö†Ô∏è Ombudsman Failed: ' + e.getMessage()); }

    System.debug('üèÜ MASTER CREATION COMPLETE.');

} catch (Exception e) {
    System.debug('üõë CRITICAL ERROR IN MAIN BLOCK: ' + e.getMessage());
    System.debug('Line: ' + e.getLineNumber());
}